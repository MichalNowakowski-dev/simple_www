<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Mój Czysty CRUD</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 600px;
        margin: 40px auto;
        padding: 20px;
        background: #f9f9f9;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
      }
      form {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      ul {
        list-style: none;
        padding: 0;
      }
      li {
        background: #fff;
        border-bottom: 1px solid #eee;
        padding: 10px;
        display: flex;
        justify-content: space-between;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Lista zadań</h1>
      <form id="zadanieForm">
        <input
          type="text"
          id="tytulInput"
          placeholder="Co trzeba zrobić?"
          required
        />
        <input type="datetime-local" id="terminInput" />
        <button type="submit">Dodaj</button>
      </form>
      <ul id="listaZadan"></ul>
      <div
        id="billing-box"
        style="
          background: #e9ecef;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
        "
      >
        <strong>Stan konta:</strong> <span id="balance">Ładowanie...</span> PLN
      </div>
    </div>

    <script>
      async function fetchZadania() {
        const res = await fetch("/zadania");
        const data = await res.json();
        const list = document.getElementById("listaZadan");

        list.innerHTML = data
          .map((z) => {
            const dataFormat = z.termin
              ? new Date(z.termin).toLocaleString()
              : "Brak daty";
            return `
                <li style="${z.zrobione ? "text-decoration: line-through; color: gray;" : ""}">
                    <div>
                        <input type="checkbox" ${z.zrobione ? "checked" : ""} 
                            onchange="toggleZadanie(${z.id}, this.checked)">
                        <strong>${z.tytul}</strong> 
                        <small>(${dataFormat})</small>
                    </div>
                </li>
            `;
          })
          .join("");
      }

      // Nowa funkcja zmiany statusu
      async function toggleZadanie(id, zrobione) {
        await fetch(`/zadania/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ zrobione }),
        });
        fetchZadania();
      }

      document.getElementById("zadanieForm").onsubmit = async (e) => {
        e.preventDefault();
        const tytul = document.getElementById("tytulInput").value;
        const termin = document.getElementById("terminInput").value;

        await fetch("/zadania", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ tytul, termin }),
        });

        document.getElementById("tytulInput").value = "";
        document.getElementById("terminInput").value = "";
        fetchZadania();
      };
      async function fetchBilling() {
        try {
          const res = await fetch("/api/billing");
          const data = await res.json();
          // Wyświetlamy np. BalanceGrossValue (wartość brutto)
          document.getElementById("balance").innerText =
            data.BalanceGrossValue.toFixed(2);
        } catch (err) {
          document.getElementById("balance").innerText = "Błąd";
        }
      }

      // Wywołaj funkcję przy starcie
      fetchBilling();

      fetchZadania();
    </script>
  </body>
</html>
